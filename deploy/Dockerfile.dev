# =============================================================================
# Loa Development Image
# =============================================================================
# Self-contained dev image that uses locally-built OpenClaw with LOA integration.
# Does NOT depend on any pre-built images from GHCR.
#
# Build context: Repository root (.)
# Build command: docker build -f deploy/Dockerfile.dev -t loa-dev:local .
#
# Prerequisites: Run `pnpm build` before building this image.
# =============================================================================

FROM docker.io/cloudflare/sandbox:0.7.0

# =============================================================================
# Stage 1: System Dependencies (same as production)
# =============================================================================

# Install Node.js 22
ENV NODE_VERSION=22.13.1
RUN apt-get update && apt-get install -y --no-install-recommends \
    xz-utils \
    ca-certificates \
    rsync \
    bubblewrap \
    socat \
    ripgrep \
    jq \
    git \
    tmux \
    zsh \
    curl \
    python3 \
    python3-pip \
    python3-venv \
    # Dev tools for hot-reload
    entr \
    inotify-tools \
    && curl -fsSLk https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-x64.tar.xz -o /tmp/node.tar.xz \
    && tar -xJf /tmp/node.tar.xz -C /usr/local --strip-components=1 \
    && rm /tmp/node.tar.xz \
    && apt-get clean && rm -rf /var/lib/apt/lists/* \
    && node --version \
    && npm --version

# Install yq (YAML processor)
RUN curl -fsSL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/local/bin/yq \
    && chmod +x /usr/local/bin/yq

# Install GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg -o /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=amd64 signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list \
    && apt-get update && apt-get install -y gh \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install pnpm and tsx globally
RUN npm install -g pnpm@10 tsx

# =============================================================================
# Stage 2: OpenClaw Gateway (local build with LOA integration)
# =============================================================================

# Create directory structure
RUN mkdir -p \
    /workspace \
    /workspace/.claude \
    /workspace/grimoires/loa \
    /workspace/deploy/loa-identity \
    /data/moltbot \
    /data/wal \
    /root/.openclaw

# Copy package files and install dependencies
COPY package.json pnpm-lock.yaml /workspace/
WORKDIR /workspace
RUN pnpm install --frozen-lockfile --ignore-scripts

# Copy built dist and entry point (built locally via `pnpm build`)
COPY dist/ /workspace/dist/
COPY openclaw.mjs /workspace/
COPY docs/reference/templates/ /workspace/docs/reference/templates/
COPY assets/ /workspace/assets/
COPY skills/ /workspace/skills/

# Create clawdbot symlink for compatibility
RUN ln -sf /workspace/openclaw.mjs /usr/local/bin/clawdbot \
    && chmod +x /workspace/openclaw.mjs \
    && node /workspace/openclaw.mjs --version

# =============================================================================
# Stage 3: Copy Loa files
# =============================================================================

# Copy startup script
COPY deploy/start-loa-dev.sh /usr/local/bin/start-loa-dev.sh
RUN chmod +x /usr/local/bin/start-loa-dev.sh

# Copy framework files (will be shadowed by volume mounts in dev)
COPY .claude/ /workspace/.claude/
COPY grimoires/ /workspace/grimoires/

# =============================================================================
# Runtime Configuration
# =============================================================================

WORKDIR /workspace

# Default environment for development
ENV BEAUVOIR_DEV_MODE=1
ENV CLAUDE_CONFIG_DIR=/workspace/.claude
ENV NODE_OPTIONS="--max-old-space-size=4096"

# Expose ports: 18789 (gateway), 3000 (health/SDK)
EXPOSE 18789 3000

# Health check
HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=3 \
    CMD curl -sf http://localhost:18789/health || exit 1

# Use dev startup script with hot-reload
ENTRYPOINT ["/usr/local/bin/start-loa-dev.sh"]
