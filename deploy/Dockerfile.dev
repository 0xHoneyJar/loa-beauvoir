# =============================================================================
# Loa Development Image
# =============================================================================
# Lightweight development image that inherits from production and adds:
# - entr: File watcher for hot-reload
# - tsx: Fast TypeScript execution
# - curl: Health check support
#
# Build context: Repository root (.)
# Build command: docker build -f deploy/Dockerfile.dev -t loa-dev:local .
# =============================================================================

ARG BASE_IMAGE=ghcr.io/0xhoneyjar/loa-beauvoir:main
FROM ${BASE_IMAGE}

# =============================================================================
# Development Tools
# =============================================================================

# Install file watcher and utilities
RUN apt-get update && apt-get install -y --no-install-recommends \
    entr \
    inotify-tools \
    curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install tsx globally for fast TypeScript execution
RUN npm install -g tsx

# =============================================================================
# Development Startup Script
# =============================================================================

# Copy dev startup script (path relative to repo root context)
COPY deploy/start-loa-dev.sh /usr/local/bin/start-loa-dev.sh
RUN chmod +x /usr/local/bin/start-loa-dev.sh

# =============================================================================
# Runtime Configuration
# =============================================================================

WORKDIR /workspace

# Default environment for development
ENV BEAUVOIR_DEV_MODE=1
ENV CLAUDE_CONFIG_DIR=/workspace/.claude
ENV NODE_OPTIONS="--max-old-space-size=4096"

# Expose ports: 18789 (gateway), 3000 (health/SDK)
EXPOSE 18789 3000

# Health check for container orchestration
HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=3 \
    CMD curl -sf http://localhost:18789/health || exit 1

# Override entrypoint for dev mode
ENTRYPOINT ["/usr/local/bin/start-loa-dev.sh"]
